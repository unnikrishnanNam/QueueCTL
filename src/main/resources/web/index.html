<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>QueueCTL ‚Ä¢ Dashboard</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="stylesheet" href="/assets/style.css" />
  </head>
  <body>
    <div class="layout">
      <aside class="sidebar">
        <div class="nav-logo"><span>QC</span> QueueCTL</div>
        <div class="nav-section">Navigation</div>
        <nav>
          <ul class="nav-links">
            <li><a class="active" href="/">Dashboard</a></li>
            <li><a href="/jobs">Jobs & Workers</a></li>
            <li><a href="/logs">Logs</a></li>
            <li><a href="/config">Config</a></li>
          </ul>
        </nav>
      </aside>
      <main>
        <div class="topbar">
          <h1>Dashboard</h1>
          <div style="font-size: 0.7rem; opacity: 0.6">Real-time telemetry</div>
        </div>
        <div class="content">
          <div class="grid grid-cols-4">
            <div class="card">
              <h2>Pending</h2>
              <div class="metric">
                <div class="icon" style="background: hsl(var(--warn))">üïó</div>
                <div>
                  <strong id="mPending">0</strong><span>Jobs pending</span>
                </div>
              </div>
            </div>
            <div class="card">
              <h2>Processing</h2>
              <div class="metric">
                <div class="icon" style="background: hsl(var(--purple))">
                  ‚öôÔ∏è
                </div>
                <div>
                  <strong id="mProcessing">0</strong
                  ><span>Jobs processing</span>
                </div>
              </div>
            </div>
            <div class="card">
              <h2>Completed</h2>
              <div class="metric">
                <div class="icon" style="background: hsl(var(--ok))">‚úÖ</div>
                <div>
                  <strong id="mCompleted">0</strong><span>Jobs completed</span>
                </div>
              </div>
            </div>
            <div class="card">
              <h2>Dead</h2>
              <div class="metric">
                <div class="icon" style="background: hsl(var(--danger))">
                  üíÄ
                </div>
                <div><strong id="mDead">0</strong><span>DLQ / Dead</span></div>
              </div>
            </div>
          </div>

          <div class="grid" style="margin-top: 1rem">
            <div class="card">
              <h2>Workers</h2>
              <div class="grid grid-cols-3">
                <div class="metric">
                  <strong id="mIdle">0</strong><span>Workers idle</span>
                </div>
                <div class="metric">
                  <strong id="mBusy">0</strong><span>Workers busy</span>
                </div>
                <div class="metric">
                  <strong id="mTotal">0</strong><span>Total workers</span>
                </div>
              </div>
            </div>
          </div>

          <div class="card" style="margin-top: 1rem">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 1rem;
                margin-bottom: 0.75rem;
              "
            >
              <h2 style="margin: 0">CPU Load (All Workers)</h2>
              <div>
                <label
                  for="perfInterval"
                  style="opacity: 0.7; font-size: 0.75rem; margin-right: 0.5rem"
                  >Refresh</label
                >
                <select id="perfInterval">
                  <option value="2000" selected>2s</option>
                  <option value="5000">5s</option>
                  <option value="10000">10s</option>
                  <option value="0">Pause</option>
                </select>
              </div>
            </div>
            <canvas id="cpuAll" height="95"></canvas>
            <div
              id="cpuLegend"
              style="
                margin-top: 0.5rem;
                display: flex;
                flex-wrap: wrap;
                gap: 0.6rem;
                font-size: 0.65rem;
                letter-spacing: 0.05em;
              "
            ></div>
          </div>
        </div>
        <!-- footer intentionally minimal (branding removed per request) -->
      </main>
    </div>
    <script src="/assets/app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // glow removed per user request
      const yearEl = qs("#year");
      if (yearEl) yearEl.textContent = new Date().getFullYear();
      async function refresh() {
        try {
          const s = await fetchJSON("/api/status");
          const st = s.states || {};
          qs("#mPending").textContent = st.PENDING ?? 0;
          qs("#mProcessing").textContent = st.PROCESSING ?? 0;
          qs("#mCompleted").textContent = st.COMPLETED ?? 0;
          qs("#mDead").textContent = st.DEAD ?? 0;
          const idle = s.workers?.idle ?? 0;
          const busy = s.workers?.busy ?? 0;
          qs("#mIdle").textContent = idle;
          qs("#mBusy").textContent = busy;
          qs("#mTotal").textContent = idle + busy;
        } catch (e) {
          console.error("status refresh failed", e);
        }
      }
      refresh();
      let statusTimer = setInterval(refresh, 2000);

      // Performance monitor
      const palette = [
        "#60a5fa",
        "#a78bfa",
        "#34d399",
        "#f472b6",
        "#f59e0b",
        "#f87171",
        "#2dd4bf",
        "#c084fc",
        "#fb7185",
        "#22c55e",
      ];
      let perfTimer = null;
      let cpuAllChart = null;
      const workerSeries = new Map(); // wid -> dataset index
      function initCpuChart() {
        if (typeof Chart === "undefined") {
          console.error("Chart.js failed to load.");
          return;
        }
        const ctx = qs("#cpuAll").getContext("2d");
        cpuAllChart = new Chart(ctx, {
          type: "line",
          data: { labels: [], datasets: [] },
          options: {
            responsive: true,
            animation: false,
            interaction: { mode: "nearest", intersect: false },
            plugins: { legend: { display: false } },
            scales: {
              x: {
                ticks: { color: "#666" },
                grid: { color: "rgba(255,255,255,0.04)" },
              },
              y: {
                min: 0,
                max: 1,
                ticks: {
                  stepSize: 0.1,
                  color: "#888",
                  callback: (v) => (Math.round(v * 10) / 10).toFixed(1),
                },
                grid: { color: "rgba(255,255,255,0.06)" },
              },
            },
          },
        });
      }

      function ema(values, alpha = 0.25) {
        const out = [];
        let prev = null;
        for (const v of values) {
          const x = v;
          if (prev == null) prev = x;
          else prev = alpha * x + (1 - alpha) * prev;
          out.push(prev);
        }
        return out;
      }
      function smoothCpu(vals) {
        let v = vals.map((x) => (x < 0 ? 0 : x));
        v = v.map((x) => (x < 0.02 ? 0 : x));
        v = ema(v, 0.3);
        return v.map((x) => Math.round(x * 100) / 100);
      }

      async function loadPerf() {
        const data = await fetchJSON("/api/workers/perf");
        if (!cpuAllChart) initCpuChart();
        if (!cpuAllChart) return;
        const active = data.filter((w) => w.status !== "STOPPED");
        const maxLen = Math.max(
          0,
          ...active.map((w) => (w.cpuHistory || []).length)
        );
        // extend labels if needed
        while (cpuAllChart.data.labels.length < maxLen) {
          cpuAllChart.data.labels.push(cpuAllChart.data.labels.length + 1);
        }
        // remove datasets for workers no longer active
        for (const [wid, idx] of Array.from(workerSeries.entries())) {
          if (!active.find((w) => w.workerId === wid)) {
            cpuAllChart.data.datasets.splice(idx, 1);
            workerSeries.delete(wid);
          }
        }
        // rebuild map (after removals) to correct indices
        cpuAllChart.data.datasets.forEach((ds, i) => {
          const wid = ds._wid;
          if (wid) workerSeries.set(wid, i);
        });
        // add/update datasets
        active.forEach((w, i) => {
          const color = palette[i % palette.length];
          const hist = smoothCpu(w.cpuHistory || []);
          if (!workerSeries.has(w.workerId)) {
            const ds = {
              label: w.workerId,
              _wid: w.workerId,
              data: hist,
              borderColor: color,
              backgroundColor: color + "33",
              tension: 0.25,
              spanGaps: true,
            };
            cpuAllChart.data.datasets.push(ds);
            workerSeries.set(w.workerId, cpuAllChart.data.datasets.length - 1);
          } else {
            const idx = workerSeries.get(w.workerId);
            cpuAllChart.data.datasets[idx].data = hist;
          }
        });
        cpuAllChart.update("none");
        // legend with click-to-toggle
        const legendRoot = qs("#cpuLegend");
        legendRoot.innerHTML = active
          .map((w, i) => {
            const color = palette[i % palette.length];
            const job = w.currentJobId
              ? `${w.currentJobId} (${Math.floor(
                  (w.currentJobElapsedMs || 0) / 1000
                )}s)`
              : "idle";
            const wid = w.workerId;
            const idx = workerSeries.get(wid);
            const hidden =
              idx != null && cpuAllChart.data.datasets[idx]?.hidden
                ? true
                : false;
            return `<button data-wid="${wid}" style="display:flex;align-items:center;gap:.35rem;padding:.25rem .5rem;border:1px solid hsl(var(--border));border-radius:.5rem;background:hsl(var(--muted));cursor:pointer;opacity:${
              hidden ? 0.5 : 0.9
            }">
            <span style="width:12px;height:12px;border-radius:3px;background:${color};box-shadow:0 0 0 1px rgba(255,255,255,0.15)"></span>
            <span style="font-weight:700">${wid}</span>
            <span style="opacity:.65">${job}</span>
          </button>`;
          })
          .join("");
        legendRoot.querySelectorAll("[data-wid]").forEach((btn) => {
          btn.onclick = () => {
            const wid = btn.getAttribute("data-wid");
            if (!workerSeries.has(wid)) return;
            const idx = workerSeries.get(wid);
            const ds = cpuAllChart.data.datasets[idx];
            ds.hidden = !ds.hidden;
            btn.style.opacity = ds.hidden ? 0.5 : 0.9;
            cpuAllChart.update("none");
          };
        });
      }

      function setPerfInterval(ms) {
        if (perfTimer) clearInterval(perfTimer);
        if (ms > 0) perfTimer = setInterval(loadPerf, ms);
      }
      setPerfInterval(2000);
      loadPerf();

      qs("#perfInterval").addEventListener("change", (e) => {
        const v = parseInt(e.target.value, 10);
        setPerfInterval(v);
      });
    </script>
  </body>
</html>
